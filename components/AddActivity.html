<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AddActivity</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/png"
      href="../src/Picture/favicon.png"
      sizes="64x64"
    />
    <link rel="shortcut icon" href="../src/Picture/favicon.png" />
    <link rel="apple-touch-icon" href="../src/Picture/favicon.png" />
    
    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../src/style/AddActivity.css" />
  </head>

  <body>
    <!-- Back button -->
    <div style="position: absolute; top: 30px; left: 30px; z-index: 1000">
      <i
        class="bi bi-arrow-left"
        onclick="window.location.href='admin_status.html'"
        style="cursor: pointer"
      ></i>
    </div>

    <!-- Logo -->
    <div style="position: absolute; top: 30px; right: 30px; z-index: 1000">
      <img
        src="../src/Picture/Logo_TU_PINE.png"
        alt="TSE white Logo"
        style="height: 120px; object-fit: contain"
      />
    </div>

    <div class="top-space"></div>

    <section class="form-box">
      <div class="title-container">
        <h2>ข้อมูลกิจกรรม</h2>
      </div>

      <form id="activityForm">
        <div class="info-fields">
          <!-- Activity Name -->
          <div class="form-floating mb-3">
            <input
              type="text"
              class="form-control readonly-field"
              id="actName"
              placeholder="ชื่อกิจกรรม"
              data-bs-toggle="tooltip"
              data-bs-placement="right"
              title="กรุณากรอกชื่อกิจกรรม"
              required
            />
            <label for="actName" style="font-size: 1.1rem">ชื่อกิจกรรม</label>
          </div>

          <div class="form-group">
            <!-- Hours -->
            <div class="form-floating mb-3">
              <input
                type="number"
                class="form-control"
                id="actHours"
                placeholder="1"
                min="1"
                step="0.5"
                data-bs-toggle="tooltip"
                data-bs-placement="right"
                title="กรุณากรอกจำนวนชั่วโมงกิจกรรม"
                required
              />
              <label for="actHours" style="font-size: 1.1rem"
                >จำนวนชั่วโมงกิจกรรม (ชั่วโมง)</label
              >
            </div>

            <!-- Organizer -->
            <div class="form-floating mb-3">
              <input
                type="text"
                class="form-control"
                id="organizer"
                placeholder="ผู้จัดกิจกรรม"
                data-bs-toggle="tooltip"
                data-bs-placement="right"
                title="กรุณากรอกผู้จัดกิจกรรม"
                required
              />
              <label for="organizer" style="font-size: 1.1rem"
                >ผู้จัดกิจกรรม</label
              >
            </div>
          </div>

          <div class="form-group">
            <!-- Start Date -->
            <div class="form-floating mb-3">
              <input
                type="date"
                class="form-control"
                id="startDate"
                data-bs-year-type="buddhist"
                placeholder="วันเริ่มจัดกิจกรรม"
                required
                onkeydown="return false;"
              />
              <label for="startDate" style="font-size: 1.1rem"
                >วันเริ่มจัดกิจกรรม</label
              >
            </div>

            <!-- End Date -->
            <div class="form-floating mb-3">
              <input
                type="date"
                class="form-control"
                id="endDate"
                data-bs-year-type="buddhist"
                placeholder="วันสิ้นสุดกิจกรรม"
                required
                onkeydown="return false;"
              />
              <label for="endDate" style="font-size: 1.1rem"
                >วันสิ้นสุดกิจกรรม</label
              >
            </div>
          </div>

          <div class="form-group">
            <!-- Activity Type -->
            <div class="form-floating">
              <select
                class="form-select"
                id="actType"
                aria-label="Floating label select example"
              >
                <option>บำเพ็ญประโยชน์</option>
                <option>วิชาการ</option>
                <option>กีฬา</option>
                <option>อื่น ๆ</option>
              </select>
              <label for="actType" style="font-size: 1.1rem"
                >ประเภทกิจกรรม</label
              >
            </div>

            <!-- Place -->
            <div class="form-floating mb-3">
              <input
                type="text"
                class="form-control"
                id="place"
                placeholder="สถานที่จัดกิจกรรม"
                data-bs-toggle="tooltip"
                data-bs-placement="right"
                title="กรุณากรอกสถานที่จัดกิจกรรม"
                required
              />
              <label for="place" style="font-size: 1.1rem"
                >สถานที่จัดกิจกรรม</label
              >
            </div>
          </div>

          <!-- Activity Info -->
          <textarea
            class="form-control"
            id="actInfo"
            placeholder="รายละเอียดกิจกรรม"
            data-bs-toggle="tooltip"
            data-bs-placement="right"
            title="กรุณากรอกรายละเอียดกิจกรรม"
            style="font-size: 1.1rem"
            required
          ></textarea>
        </div>
      </form>

      <div class="title-container">
        <h2>อัปโหลดรูปภาพที่เกี่ยวข้องกับกิจกรรม</h2>
      </div>

      <form>
        <!-- Upload -->
        <div class="file-upload text-center">
          <label class="upload-label mb-2">
            อัปโหลดรูปภาพที่เกี่ยวข้องกับกิจกรรม (ไม่เกิน 1 รูป)
            <span
              id="uploadWarning"
              class="text-danger"
              data-bs-toggle="tooltip"
              data-bs-placement="right"
              title="กรุณาอัปโหลดรูปภาพ (.jpg เท่านั้น)"
              style="display: none; cursor: pointer"
            >
              *
            </span>
          </label>

          <div class="preview" id="previewContainer"></div>
          <div class="upload-row">
            <button
              type="button"
              id="uploadBtn"
              class="btn upload-btn"
              style="font-size: 1.1rem"
            >
              อัปโหลดรูปภาพ (.jpg)
            </button>
            <span id="fileName" class="file-name" style="font-size: 1.2rem"
              >ยังไม่ได้เลือกไฟล์</span
            >
          </div>
          <input type="file" id="uploadFile" accept="image/*" hidden />
        </div>
      </form>
    </section>

    <div class="confirm-section">
      <button
        type="button"
        id="submitBtn"
        class="submit-btn"
        style="font-size: 1.1rem"
        disabled
      >
        ยืนยันข้อมูล
      </button>
    </div>

    <!-- ========= Bootstrap Bundle ========= -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ========= Modal Function ========= -->
    <script>
      function openSuccessModal(msg) {
        document.querySelector("#successModal .modal-body p").textContent = msg;
        const modal = new bootstrap.Modal(
          document.getElementById("successModal")
        );
        modal.show();
      }
    </script>

    <script>
      // ========== ELEMENTS ==========
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadInput = document.getElementById("uploadFile");
      const fileNameLabel = document.getElementById("fileName");
      const previewContainer = document.getElementById("previewContainer");
      const submitBtn = document.getElementById("submitBtn");
      const form = document.getElementById("activityForm");
      let imgLink = null;
      let uploadedFile = null;

      // Enable Bootstrap tooltips
      const tooltipTriggerList = [].slice.call(
        document.querySelectorAll('[data-bs-toggle="tooltip"]')
      );
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });

      // ========== UPLOAD ==========
      uploadBtn.addEventListener("click", () => uploadInput.click());

      uploadInput.addEventListener("change", function () {
        const file = this.files[0];
        previewContainer.innerHTML = "";

        if (!file) {
          fileNameLabel.textContent = "ยังไม่ได้เลือกไฟล์";
          uploadedFile = null;
          imgLink = null;
          updateSubmitState();
          return;
        }

        if (this.files.length > 1) {
          openSuccessModal("สามารถอัปโหลดได้เพียง 1 รูปเท่านั้น");
          this.value = "";
          fileNameLabel.textContent = "ยังไม่ได้เลือกไฟล์";
          uploadedFile = null;
          imgLink = null;
          updateSubmitState();
          return;
        }

        const fileExt = file.name.split(".").pop().toLowerCase();
        if (fileExt !== "jpg" && fileExt !== "jpeg") {
          openSuccessModal("กรุณาอัปโหลดไฟล์ .jpg เท่านั้น");
          this.value = "";
          fileNameLabel.textContent = "ยังไม่ได้เลือกไฟล์";
          uploadedFile = null;
          imgLink = null;
          updateSubmitState();
          return;
        }

        uploadedFile = file;
        fileNameLabel.textContent = file.name;
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = document.createElement("img");
          img.src = e.target.result;
          imgLink = e.target.result;
          previewContainer.appendChild(img);
        };
        reader.readAsDataURL(file);
        updateSubmitState();
      });

      // ========== VALIDATION ==========
      function allFieldsFilled() {
        const requiredInputs = form.querySelectorAll(
          "input[required], select[required], textarea[required]"
        );
        for (const input of requiredInputs) {
          if (!input.value.trim()) return false;
        }
        return true;
      }

      function updateSubmitState() {
        submitBtn.disabled = !allFieldsFilled();
        submitBtn.classList.toggle("enabled", allFieldsFilled());
      }

      form.addEventListener("input", updateSubmitState);

      // ========== BUDDHIST DATE CONVERSION ==========
      function toBuddhistDateInput(date) {
        const day = ("0" + date.getDate()).slice(-2);
        const month = ("0" + (date.getMonth() + 1)).slice(-2);
        const year = date.getFullYear() + 543;
        return `${year}-${month}-${day}`;
      }

      function fromBuddhistDateInput(value) {
        const [year, month, day] = value.split("-").map(Number);
        return new Date(year - 543, month - 1, day);
      }

      const dateInputs = document.querySelectorAll(
        'input[type="date"][data-bs-year-type="buddhist"]'
      );

      const minBuddhistYear = 2560;
      const minDate = new Date(minBuddhistYear - 543, 0, 1);

      const maxBuddhistYear = 2569;
      const maxDate = new Date(maxBuddhistYear - 543, 11, 31);

      dateInputs.forEach((input) => {
        const today = new Date();
        input.value = toBuddhistDateInput(today);

        input.min = toBuddhistDateInput(minDate);
        input.max = toBuddhistDateInput(maxDate);

        input.addEventListener("change", (e) => {
          const jsDate = fromBuddhistDateInput(e.target.value);
          if (jsDate > maxDate) {
            openSuccessModal(`ปีสูงสุดที่เลือกได้คือ พ.ศ.${maxBuddhistYear}`);
            input.value = toBuddhistDateInput(maxDate);
          }
        });
      });

      // ========== SUBMIT ==========
      submitBtn.addEventListener("click", async () => {
        if (!allFieldsFilled()) {
          openSuccessModal("กรุณากรอกข้อมูลให้ครบทุกช่องก่อนยืนยัน");
          return;
        }

        const startDate = fromBuddhistDateInput(
          document.getElementById("startDate").value
        );
        const endDate = fromBuddhistDateInput(
          document.getElementById("endDate").value
        );

        const fetchData = {
          name: document.getElementById("actName").value.trim(),
          hours: parseFloat(document.getElementById("actHours").value),
          provider: document.getElementById("organizer").value.trim(),
          start_date: startDate.toISOString().split("T")[0],
          end_date: endDate.toISOString().split("T")[0],
          type: document.getElementById("actType").value,
          location: document.getElementById("place").value.trim(),
          img: imgLink,
          detail: document.getElementById("actInfo").value.trim(),
        };

        try {
          const response = await fetch("/api/add_activity", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(fetchData),
          });

          if (!response.ok) throw new Error("Network response was not ok");

          const data = await response.json();
          console.log("Success:", data);

          openSuccessModal("ส่งข้อมูลสำเร็จ!");

          form.reset();
          previewContainer.innerHTML = "";
          fileNameLabel.textContent = "ยังไม่ได้เลือกไฟล์";
          uploadedFile = null;
          imgLink = null;
          updateSubmitState();

          document
            .getElementById("closeModalBtn")
            .addEventListener("click", () => {
              window.location.href = "admin_status.html";
            });
        } catch (error) {
          console.error("Error:", error);
          openSuccessModal("เกิดข้อผิดพลาดในการส่งข้อมูล");
        }
      });
    </script>

    <!-- ========= Success Modal ========= -->
    <div
      class="modal fade modal-top"
      id="successModal"
      tabindex="-1"
      aria-labelledby="successModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="successModalLabel">System.says</h5>
          </div>
          <div class="modal-body text-left">
            <p>ส่งข้อมูล สำเร็จ!</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              id="closeModalBtn"
              class="btn btn-danger"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
