<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login</title>

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/png"
      href="../src/Picture/favicon.png"
      sizes="64x64"
    />
    <link rel="shortcut icon" href="../src/Picture/favicon.png" />
    <link rel="apple-touch-icon" href="../src/Picture/favicon.png" />

    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../src/style/Login.css" />
  </head>
  <body>
    <div
      class="main-container d-flex flex-column justify-content-center align-items-center"
    >
      <div id="alert-container" class="alert-container"></div>

      <!-- Login Box -->
      <div class="login-box p-5">
        <h2 class="text-center">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö!</h2>

        <div class="form-area">
          <form>
            <!-- Email -->
            <div class="form-floating mb-3">
              <input
                type="email"
                class="form-control"
                id="email"
                name="email"
                placeholder="Enter Email"
                required
              />
              <label for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            </div>

            <!-- Password -->
            <div class="form-floating mb-4 position-relative">
              <input
                type="password"
                class="form-control"
                id="password"
                name="password"
                placeholder="Enter Password"
                required
              />
              <label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
              <!-- Eye icon -->
              <span
                id="togglePassword"
                class="position-absolute top-50 end-0 translate-middle-y pe-3"
                style="cursor: pointer; user-select: none"
              >
                <i class="bi bi-eye"></i>
              </span>
            </div>

            <!-- Button -->
            <div class="d-flex justify-content-center">
              <button type="submit" class="btn btn-login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.querySelector("form").addEventListener("submit", handleLogin);
      let student_id = null;

      function showAlert(message, type = "danger", role) {
        const container = document.getElementById("alert-container");

        // üîπ [‡πÅ‡∏Å‡πâ] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡πâ progress bar ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
        const alert = document.createElement("div");
        alert.className = `custom-toast border-start border-4 border-${type}`;
        alert.innerHTML = `
        <div class="toast-header">
          <strong class="me-auto text-${type}">${message}</strong>
          <button type="button" class="btn-close ms-2 mb-1" aria-label="Close"></button>
        </div>
        <div class="toast-progress bg-${type}"></div>  <!-- üîπ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡πá‡∏Å‡πÉ‡∏ï‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á -->
      `;

        container.appendChild(alert);

        // ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î toast
        alert
          .querySelector(".btn-close")
          .addEventListener("click", () => alert.remove());

        // ‡πÉ‡∏´‡πâ progress bar ‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏•‡∏î
        setTimeout(() => {
          alert.querySelector(".toast-progress").style.width = "0%";
        }, 100);

        // ‡πÉ‡∏´‡πâ toast ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        setTimeout(() => {
          alert.style.opacity = "0";
          setTimeout(() => alert.remove(), 500);
          if (type === "success" && role === "student") {
            window.location.href = `/HomePage.html?id=${encodeURIComponent(
              student_id
            )}`;
          } else if (type === "success" && role === "admin") {
            window.location.href = `/home_admin.html`;
          }
        }, 3000);
      }

      function handleLogin() {
        event.preventDefault(); // Prevent form from submitting and refreshing the page

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        if ((password === "") | (email === "")) {
          showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", "notice");
          return;
        } else {
          fetch(
            "/api/login/:email/:password"
              .replace(":email", email)
              .replace(":password", password)
          )
            .then((response) => response.json())
            .then((data) => {
              console.log(data);

              const isUser = data.user !== null && data.user !== undefined;
              const isAdmin = data.admin !== null && data.admin !== undefined;

              console.log("isUser:", isUser);
              console.log("isAdmin:", isAdmin);

              if (!isUser && !isAdmin) {
                showAlert("‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô", "danger");
                return;
              } else if (
                (isUser && !data.passwordMatch) ||
                (isAdmin && !data.passwordMatch)
              ) {
                showAlert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "danger");
                return;
              } else if (
                (isUser && data.passwordMatch) ||
                (isAdmin && data.passwordMatch)
              ) {
                if (isUser) {
                  student_id = data.student.student_id;
                  showAlert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ", "success", "student");
                } else {
                  showAlert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ", "success", "admin");
                }
              }
            });
        }
      }

      const togglePassword = document.getElementById("togglePassword");
      const passwordField = document.getElementById("password");

      togglePassword.addEventListener("click", () => {
        const type =
          passwordField.getAttribute("type") === "password"
            ? "text"
            : "password";
        passwordField.setAttribute("type", type);

        // Toggle icon
        const icon = togglePassword.querySelector("i");
        icon.classList.toggle("bi-eye");
        icon.classList.toggle("bi-eye-slash");
      });
      
    </script>
  </body>
</html>
