<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>เลือกกิจกรรมออกใบบทรานสคริปต์</title>

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/png"
      href="../src/Picture/favicon.png"
      sizes="64x64"
    />
    <link rel="shortcut icon" href="../src/Picture/favicon.png" />
    <link rel="apple-touch-icon" href="../src/Picture/favicon.png" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="../src/style/select_act.css" />
  </head>

  <body>
    <!-- Home icon -->
    <div style="position: absolute; top: 30px; left: 30px; z-index: 1000">
      <i id="homeIcon" class="bi bi-house-fill" style="cursor: pointer"></i>
    </div>

    <!-- Logo top-right -->
    <div style="position: absolute; top: 30px; right: 30px; z-index: 1000">
      <img
        src="../src/Picture/Logo_TU_PINE.png"
        alt="TSE white Logo"
        style="height: 120px; object-fit: contain"
      />
    </div>

    <div class="container-box" style="position: relative">
      <div class="main-card">
        <div class="card-header bg-white border-0">
          <h3 class="fw-bold mb-0">เลือกกิจกรรมเพื่อออกใบทรานสคริปต์</h3>
        </div>

        <div class="card-body"></div>
      </div>

      <div class="confirm-checkbox mt-3 d-flex align-items-center">
        <input type="checkbox" id="confirm" />
        <label for="confirm" class="mb-0">ยืนยันการออกใบทรานสคริปต์</label>
        <span
          id="confirmWarning"
          class="ms-2 text-danger"
          data-bs-toggle="tooltip"
          data-bs-placement="right"
          title="กรุณาทำเครื่องหมายยืนยันก่อนออกใบทรานสคริปต์"
          >&#9888;</span
        >
      </div>

      <button
        onclick="window.location='Transcript_PDF_template.html'"
        id="btnTranscript"
        class="btn btn-transcript mt-2"
        disabled
      >
        ออกใบทรานสคริปต์
      </button>
      <div style="height: 16px"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
    <script src="../components/navigation.js"></script>

    <script>
      const confirmCheckbox = document.getElementById("confirm");
      const confirmWarning = document.getElementById("confirmWarning");
      const btnTranscript = document.getElementById("btnTranscript");

      function initTooltips() {
        const tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        tooltipTriggerList.map((el) => new bootstrap.Tooltip(el));
      }

      // ✅ Store selected activity IDs in server session
      async function storeSelectedIdsInSession(selectedActIds) {
        try {
          await fetch("/api/student/selected-activities", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ selectedActIds }),
          });
        } catch (err) {
          console.error("Failed to store selectedActIds in session:", err);
        }
      }

      function updateButtonState() {
        const activityCheckboxes = document.querySelectorAll(
          '.activity-card input[type="checkbox"]'
        );

        const selectedActIds = Array.from(activityCheckboxes)
          .filter((cb) => cb.checked)
          .map((cb) => cb.dataset.actId)
          .filter(Boolean);

        // Remove duplicates
        const uniqueIds = Array.from(new Set(selectedActIds));

        // Send to server session
        storeSelectedIdsInSession(uniqueIds);

        // Update UI
        const anyActivityChecked = uniqueIds.length > 0;
        const confirmChecked = confirmCheckbox?.checked;
        btnTranscript.disabled = !(anyActivityChecked && confirmChecked);

        if (!confirmChecked) {
          confirmWarning?.classList.add("show-warning");
        } else {
          confirmWarning?.classList.remove("show-warning");
        }
      }

      (async function init() {
        try {
          let studentId = null;

          const meResp = await fetch("/api/student_info/me");
          if (meResp.ok) {
            const meData = await meResp.json();
            studentId = meData.student_id || null;
          }

          const reqResp = await fetch(
            "/api/requests/" + encodeURIComponent(studentId)
          );
          const requests = await reqResp.json();

          const statusListContainer = document.querySelector(".card-body");
          statusListContainer.innerHTML = "";

          if (!Array.isArray(requests) || requests.length === 0) {
            statusListContainer.innerHTML =
              '<div class="text-muted" style="font-size: 1.2rem">ยังไม่มีคำขอ</div>';
            updateButtonState();
            return;
          }

          const activityFetches = requests.map((r) =>
            fetch("/api/activity/" + encodeURIComponent(r.act_id))
              .then((res) =>
                res.ok
                  ? res.json().then((act) => ({ request: r, activity: act }))
                  : Promise.reject()
              )
              .catch(() => ({ request: r, activity: null }))
          );

          const results = await Promise.all(activityFetches);

          const isApproved = (s) => {
            if (!s) return false;
            const x = String(s).trim().toLowerCase();
            return x === "approved" || x === "อนุมัติ";
          };

          const mapByAct = new Map();
          results.forEach(({ request, activity }) => {
            const actId =
              activity?.activity_id ?? request.act_id ?? request.activity_id ?? "";
            mapByAct.set(String(actId), { request, activity });
          });
          const uniqueResults = Array.from(mapByAct.values());

          const approvedResults = uniqueResults.filter(({ request }) =>
            isApproved(request.status)
          );

          if (approvedResults.length === 0) {
            statusListContainer.innerHTML = `
              <div class="text-muted" style="font-size: 1.2rem">
                ยังไม่มีกิจกรรมที่ได้รับการอนุมัติ
              </div>
            `;
            updateButtonState();
            return;
          }

          approvedResults.forEach(({ request, activity }) => {
            const statusItem = document.createElement("div");
            statusItem.className =
              "activity-card d-flex justify-content-between align-items-center p-2";

            const actName = activity?.act_name || request.act_name || "กิจกรรม";
            const dateText = activity?.start_date
              ? new Date(activity.start_date).toLocaleDateString("th-TH")
              : request.request_date
              ? new Date(request.request_date).toLocaleDateString("th-TH")
              : "";

            const frontendActId =
              activity?.activity_id ?? activity?.act_id ?? request.act_id ?? request.activity_id ?? "";

            statusItem.innerHTML = `
              <span class="fw-medium" style="font-size: 1.1rem">${actName}</span>
              <div class="d-flex align-items-center">
                <span class="me-3 text-muted" style="font-size: 1.1rem">${dateText}</span>
                <input type="checkbox" data-act-id="${frontendActId}" />
              </div>
            `;

            statusListContainer.appendChild(statusItem);
          });

          initTooltips();

          const activityCheckboxes = document.querySelectorAll(
            '.activity-card input[type="checkbox"]'
          );
          activityCheckboxes.forEach((cb) =>
            cb.addEventListener("change", updateButtonState)
          );
          confirmCheckbox?.addEventListener("change", updateButtonState);

          updateButtonState();
        } catch (err) {
          console.error("Error initializing page:", err);
        }
      })();
    </script>
  </body>
</html>
