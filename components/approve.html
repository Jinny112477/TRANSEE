<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transee</title>

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/png"
      href="../src/Picture/favicon.png"
      sizes="64x64"
    />
    <link rel="shortcut icon" href="../src/Picture/favicon.png" />
    <link rel="apple-touch-icon" href="../src/Picture/favicon.png" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../src/style/approve.css" />
  </head>

  <body>
    <!-- üîô Back Button -->
    <div style="position: absolute; top: 30px; left: 30px; z-index: 1000">
      <i id="backButton" class="bi bi-arrow-left" style="cursor: pointer"></i>
    </div>

    <!-- Logo -->
    <div style="position: absolute; top: 30px; right: 30px; z-index: 1000">
      <img
        src="../src/Picture/Logo_TU_PINE.png"
        alt="TSE white Logo"
        style="height: 120px"
      />
    </div>

    <div class="top-space"></div>

    <!-- Banner -->
    <div class="banner-box">
      <img id="banner" src="../src/Picture/banner.png" alt="banner" />
    </div>

    <!-- Activity Box -->
    <section class="activity-box">
      <h1 class="title" id="title"></h1>
      <ul class="activity-list">
        <li><i class="bi bi-clock" id="hour"></i></li>
        <li><i class="bi bi-people-fill" id="provider"></i></li>
        <li><i class="bi bi-list-task" id="type"></i></li>
        <li><i class="bi bi-calendar-event" id="date"></i></li>
        <li><i class="bi bi-geo-alt-fill" id="place"></i></li>
      </ul>

      <h4 class="subtitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h4>
      <p class="activity-detail" id="detail"></p>
    </section>

    <!-- Student Box -->
    <section class="form-box">
      <h3 class="form-title">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>

      <div class="form-row">
        <input
          type="text"
          id="std_name"
          class="form-control readonly-field"
          readonly
        />
        <input
          type="text"
          id="std_id"
          class="form-control readonly-field"
          readonly
        />
      </div>

      <div class="mb-3">
        <input
          type="text"
          id="role"
          class="form-control readonly-field"
          readonly
        />
      </div>

      <div class="file-preview text-center">
        <label class="upload-label mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
        <div class="preview" id="previewContainer">
          <img id="img" src="pic/sample.jpg" alt="‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô" />
        </div>
      </div>
    </section>

    <!-- Approve / Reject -->
    <div class="approve-section">
      <button class="btn btn-success btn-lg px-5" id="approveBtn">
        ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
      </button>
      <button class="btn btn-danger btn-lg px-5" id="rejectBtn">
        ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
      </button>
    </div>

    <!-- Confirm Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-top">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">System says</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body text-left">
            <p id="modalMessage" class="fs-5"></p>
          </div>
          <div class="modal-footer justify-content-center">
            <button
              type="button"
              class="btn btn-confirm"
              id="confirmBtn"
              data-bs-dismiss="modal"
            >
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SUCCESS MODAL -->
    <div class="modal fade modal-top" id="successModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">System.says</h5>
          </div>
          <div class="modal-body">
            <p id="successMessage" class="fs-5"></p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ERROR MODAL -->
    <div class="modal fade modal-top" id="errorModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">System.says</h5>
          </div>
          <div class="modal-body text-left">
            <p id="errorMessage" class="fs-5"></p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
    <script src="../components/navigation.js"></script>

    <script>
      const approveBtn = document.getElementById("approveBtn");
      const rejectBtn = document.getElementById("rejectBtn");
      const confirmBtn = document.getElementById("confirmBtn");
      const modal = new bootstrap.Modal(document.getElementById("resultModal"));
      const modalMessage = document.getElementById("modalMessage");

      let pendingAction = null;

      // === CE ‚Üí BE Helper ===
      function toBE(dateString) {
        const d = new Date(dateString);
        if (isNaN(d)) return dateString;

        const day = d.getDate().toString().padStart(2, "0");
        const month = (d.getMonth() + 1).toString().padStart(2, "0");
        const yearBE = d.getFullYear() + 543;

        return `${day}/${month}/${yearBE}`;
      }

      // === SUCCESS + ERROR ===
      function showSuccess(msg) {
        document.getElementById("successMessage").textContent = msg;
        new bootstrap.Modal(document.getElementById("successModal")).show();
      }

      function showError(msg) {
        document.getElementById("errorMessage").textContent = msg;
        new bootstrap.Modal(document.getElementById("errorModal")).show();
      }

      // Load Data
      fetch(
        "/api/approve_page/:id".replace(
          ":id",
          new URLSearchParams(window.location.search).get("req_id")
        )
      )
        .then((res) => res.json())
        .then((data) => {
          document.getElementById("banner").src =
            data.add_activity.act_img || "../src/Picture/banner.png";
          document.getElementById("title").textContent =
            " " + data.add_activity.act_name;
          document.getElementById("hour").textContent =
            " ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° " + data.add_activity.act_hour + " ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á";
          document.getElementById("provider").textContent =
            " " + data.add_activity.provider_name;
          document.getElementById("type").textContent =
            " " + data.add_activity.act_type;

          // --- CE ‚Üí BE ---
          document.getElementById("date").textContent =
            " " + toBE(data.add_activity.start_date);

          document.getElementById("place").textContent =
            " " + data.add_activity.place;
          document.getElementById("detail").textContent =
            " " + data.add_activity.description;
          document.getElementById("std_id").value = " " + data.student_id;
          document.getElementById("std_name").value =
            " " + data.student_info.full_name;
          document.getElementById("role").value = " " + data.role;
          document.getElementById("img").src = data.image;
        });

      // Approve
      approveBtn.addEventListener("click", () => {
        modalMessage.textContent = "‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?";
        pendingAction = "approve";
        modal.show();
      });

      // Reject
      rejectBtn.addEventListener("click", () => {
        modalMessage.textContent = "‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?";
        pendingAction = "reject";
        modal.show();
      });

      // Confirm
      confirmBtn.addEventListener("click", () => {
        const reqId = new URLSearchParams(window.location.search).get("req_id");

        if (pendingAction === "approve") {
          fetch(`/api/update_status/${reqId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: "approved" }),
          });
          showSuccess("‚úÖ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        }

        if (pendingAction === "reject") {
          fetch(`/api/update_status/${reqId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: "rejected" }),
          });
          showError("‚ùå ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        }

        pendingAction = null;

        // Redirect after 1.3 sec
        setTimeout(() => {
          window.location.href = "admin_status.html";
        }, 1300);
      });
    </script>
  </body>
</html>
